<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Global Cancer Information (2022)</title>
  <script src="https://cdn.jsdelivr.net/npm/vega@6.2.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@6.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@7.0.2"></script>
  <style>
    .vega-actions a { margin-right: 5px; }
    .chart-container { margin-bottom: 40px; }
  </style>
</head>
<body>
  <h2 class="title">Global Cancer Information (2022)</h2>
  <h5 class="subtitle">* ASR = Age-Standardized Rate per 100,000 population</h5>

  <div id="combined"></div>

  <script>
    var vlSpec = {
      $schema: "https://vega.github.io/schema/vega-lite/v6.json",

      // Shared parameter: multi-select dropdown
      params: [
        {
          name: "selectedCountries",
          bind: {
            input: "select",
            options: ["Cambodia","Eritrea","Germany","South Sudan","Vietnam","United States"],
            multiple: true,
            size: 6
          },
          value: ["Cambodia","Germany"]   // default selection
        }
      ],

      vconcat: [
        // Choropleth Map
        {
          title: "Global Cancer Prevalence Cases (2022)",
          width: 700,
          height: 400,
          projection: { type: "equalEarth" },
          layer: [
            {
              data: {
                url: "https://vega.github.io/vega-datasets/data/world-110m.json",
                format: { type: "topojson", feature: "countries" }
              },
              mark: { type: "geoshape", fill: "lightgray", stroke: "white" }
            },
            {
              data: {
                url: "https://vega.github.io/vega-datasets/data/world-110m.json",
                format: { type: "topojson", feature: "countries" }
              },
              transform: [
                {
                  lookup: "id",
                  from: {
                    data: { url: "prevalence_mortality_updt.csv" },
                    key: "NumericCode",
                    fields: ["Country","PrevalenceCases"]
                  }
                },
                { filter: "indexof(selectedCountries, datum.Country) >= 0" }
              ],
              mark: { type: "geoshape", stroke: "black", strokeWidth: 0.5 },
              encoding: {
                color: {
                  field: "PrevalenceCases",
                  type: "quantitative",
                  scale: { scheme: "reds" },
                  legend: { title: "Cancer Prevalence Cases (ASR)" }
                },
                tooltip: [
                  { field: "Country", type: "nominal" },
                  { field: "PrevalenceCases", type: "quantitative" }
                ]
              }
            }
          ]
        },

        // Slope Graph
        {
          title: "Global Cancer Incidence and Mortality Rate (2022)",
          width: 700,
          height: 400,
          data: { url: "slope.csv" },
          config: { view: { stroke: "transparent" } },
          background: "#e5cefcfe",
          transform: [
            {
              joinaggregate: [
                { op: "max", field: "Cancer ASR rate", as: "incidence" }
              ],
              groupby: ["Country"]
            },
            {
              window: [
                { op: "rank", field: "incidence", as: "rank" }
              ],
              sort: [{ field: "incidence", order: "descending" }]
            },
            { filter: "indexof(selectedCountries, datum.Country) >= 0" }
          ],
          encoding: {
            x: {
              field: "Measure",
              type: "nominal",
              sort: ["Incidence","Mortality"],
              scale: { paddingInner: 0, paddingOuter: 0 },
              axis: { domain: false, ticks: false, labels: true, labelAngle: 0 }
            },
            y: {
              field: "Cancer ASR rate",
              type: "quantitative",
              axis: { title: "ASR per 100,000", grid: true, tickCount: 6 }
            }
          },
          layer: [
            {
              mark: { type: "line", strokeWidth: 2 },
              encoding: {
                detail: { field: "Country" },
                color: { field: "Country", type: "nominal" }
              }
            },
            {
              mark: { type: "point", filled: true },
              encoding: {
                detail: { field: "Country" },
                color: { field: "Country", type: "nominal" }
              }
            },
            { mark: { type: "rule", stroke: "#888", strokeWidth: 0.5 }, encoding: { x: { datum: "Incidence" } } },
            { mark: { type: "rule", stroke: "#888", strokeWidth: 0.5 }, encoding: { x: { datum: "Mortality" } } }
          ]
        }
      ]
    };

    vegaEmbed("#combined", vlSpec, { actions: false });
  </script>
</body>
</html>
